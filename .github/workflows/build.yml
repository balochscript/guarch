name: Build Guarch

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Download dependencies
        run: |
          go mod tidy
          go mod download

      - name: Run tests
        run: go test ./... -v

      - name: Build server (Linux AMD64)
        run: |
          GOOS=linux GOARCH=amd64 go build -o bin/guarch-server-linux-amd64 ./cmd/guarch-server/
          GOOS=linux GOARCH=arm64 go build -o bin/guarch-server-linux-arm64 ./cmd/guarch-server/

      - name: Build client (Linux AMD64)
        run: |
          GOOS=linux GOARCH=amd64 go build -o bin/guarch-client-linux-amd64 ./cmd/guarch-client/

      - name: Build client (Windows)
        run: |
          GOOS=windows GOARCH=amd64 go build -o bin/guarch-client-windows.exe ./cmd/guarch-client/

      - name: Upload server binaries
        uses: actions/upload-artifact@v4
        with:
          name: guarch-server
          path: bin/guarch-server-*

      - name: Upload client binaries
        uses: actions/upload-artifact@v4
        with:
          name: guarch-client
          path: bin/guarch-client-*

  build-android:
    runs-on: ubuntu-latest
    needs: build-server
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;25.2.9519653"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Download Go dependencies
        run: |
          go mod tidy
          go mod download

      - name: Install gomobile
        run: |
          go get golang.org/x/mobile/bind
          go get golang.org/x/mobile/cmd/gomobile
          go get golang.org/x/mobile/cmd/gobind
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          export PATH=$PATH:$(go env GOPATH)/bin
          echo "PATH=$PATH:$(go env GOPATH)/bin" >> $GITHUB_ENV
          gomobile init

      - name: Build Go mobile library
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          mkdir -p app/android/app/libs
          gomobile bind -target=android -androidapi 21 \
            -o app/android/app/libs/mobile.aar \
            ./mobile/

      - name: Generate app icon from assets
        working-directory: app
        run: |
          sudo apt-get install -y imagemagick

          ICON_SRC="assets/icon.png"

          if [ ! -f "$ICON_SRC" ]; then
            echo "ERROR: icon not found at $ICON_SRC"
            exit 1
          fi

          echo "Using icon: $ICON_SRC"
          identify "$ICON_SRC"

          # ---- mipmap (launcher icon) ----
          mkdir -p android/app/src/main/res/mipmap-mdpi
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi

          convert "$ICON_SRC" -resize 48x48   android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          convert "$ICON_SRC" -resize 72x72   android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert "$ICON_SRC" -resize 96x96   android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert "$ICON_SRC" -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert "$ICON_SRC" -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png

          # ---- round icon (same source, cropped to circle) ----
          for pair in "mdpi 48" "hdpi 72" "xhdpi 96" "xxhdpi 144" "xxxhdpi 192"; do
            set -- $pair
            DENSITY=$1
            SIZE=$2
            HALF=$((SIZE / 2))

            convert "$ICON_SRC" -resize ${SIZE}x${SIZE} \
              \( +clone -threshold -1 -negate \
                 -fill white -draw "circle $HALF,$HALF $HALF,0" \) \
              -alpha off -compose copy_opacity -composite \
              "android/app/src/main/res/mipmap-${DENSITY}/ic_launcher_round.png"
          done

          echo "âœ… All icons generated"
          ls -lR android/app/src/main/res/mipmap-*/

      - name: Flutter dependencies
        working-directory: app
        run: |
          rm -f pubspec.lock
          flutter pub get

      - name: Build APK
        working-directory: app
        run: |
          flutter build apk --release 2>&1 | tee /tmp/build.log || true
          echo ""
          echo "========================================="
          echo "ERRORS FOUND:"
          echo "========================================="
          grep -i "error\|FAILURE\|failed\|exception" /tmp/build.log | head -30
          echo ""
          echo "========================================="
          echo "FULL LOG (first 200 lines):"
          echo "========================================="
          head -200 /tmp/build.log

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: guarch-android
          path: app/build/app/outputs/flutter-apk/app-release.apk
