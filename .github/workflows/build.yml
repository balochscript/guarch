name: Build Guarch Debug

on:
  push:
    branches: [ debug ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;25.2.9519653"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Download Go dependencies
        run: |
          go mod tidy
          go mod download

      - name: Install gomobile
        run: |
          # ۱. اضافه کردن x/mobile به go.mod
          go get golang.org/x/mobile@latest
          go get golang.org/x/mobile/bind@latest
          
          # ۲. نصب ابزارها
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          
          export PATH=$PATH:$(go env GOPATH)/bin
          echo "PATH=$PATH:$(go env GOPATH)/bin" >> $GITHUB_ENV
          
          # ۳. init
          gomobile init
          
          # ۴. sync مجدد
          go mod tidy
          
          # ۵. تأیید
          echo "gomobile: $(which gomobile)"
          echo "gobind: $(which gobind)"

      - name: Build mobile.aar
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          mkdir -p app/android/app/libs
          
          echo "=== Building mobile.aar ==="
          gomobile bind -v -target=android -androidapi 21 \
            -o app/android/app/libs/mobile.aar \
            ./mobile/ 2>&1 | tee /tmp/gomobile.log
          
          echo ""
          echo "=== Result ==="
          ls -la app/android/app/libs/

      - name: Verify mobile.aar
        run: |
          if [ -f "app/android/app/libs/mobile.aar" ]; then
            echo "✅ mobile.aar found ($(du -h app/android/app/libs/mobile.aar | cut -f1))"
          else
            echo "❌ mobile.aar NOT FOUND"
            echo ""
            echo "=== gomobile log ==="
            cat /tmp/gomobile.log
            exit 1
          fi

      - name: Generate app icons
        working-directory: app
        run: |
          sudo apt-get install -y imagemagick
          ICON_SRC="assets/icon.png"
          if [ ! -f "$ICON_SRC" ]; then
            mkdir -p assets
            convert -size 512x512 xc:'#D4A574' \
              -fill '#2C1810' -gravity center -pointsize 200 -annotate 0 'G' \
              "$ICON_SRC"
          fi
          for pair in "mdpi 48" "hdpi 72" "xhdpi 96" "xxhdpi 144" "xxxhdpi 192"; do
            set -- $pair
            DENSITY=$1; SIZE=$2; HALF=$((SIZE / 2))
            mkdir -p android/app/src/main/res/mipmap-${DENSITY}
            convert "$ICON_SRC" -resize ${SIZE}x${SIZE} \
              android/app/src/main/res/mipmap-${DENSITY}/ic_launcher.png
            convert "$ICON_SRC" -resize ${SIZE}x${SIZE} \
              \( +clone -threshold -1 -negate \
                 -fill white -draw "circle $HALF,$HALF $HALF,0" \) \
              -alpha off -compose copy_opacity -composite \
              android/app/src/main/res/mipmap-${DENSITY}/ic_launcher_round.png
          done
          echo "✅ Icons done"

      - name: Check files
        working-directory: app
        run: |
          for f in \
            "lib/main.dart" \
            "lib/app.dart" \
            "lib/providers/app_provider.dart" \
            "lib/services/guarch_engine.dart" \
            "lib/screens/home_screen.dart" \
            "lib/screens/log_viewer_screen.dart" \
            "android/app/src/main/kotlin/com/guarch/app/MainActivity.kt" \
            "android/app/src/main/kotlin/com/guarch/app/GuarchService.kt" \
            "android/app/src/main/kotlin/com/guarch/app/CrashLogger.kt" \
            "android/app/src/main/AndroidManifest.xml" \
            "android/app/libs/mobile.aar"; do
            if [ -f "$f" ]; then
              echo "  ✅ $f"
            else
              echo "  ❌ $f"
            fi
          done

      - name: Flutter pub get
        working-directory: app
        run: |
          rm -f pubspec.lock
          flutter pub get

      - name: Build Debug APK
        working-directory: app
        run: |
          flutter build apk --debug 2>&1 | tee /tmp/build.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "=== BUILD FAILED ==="
            grep -i "error\|FAILURE" /tmp/build.log | head -30
            tail -80 /tmp/build.log
            exit 1
          fi
          echo "✅ APK built"
          ls -la build/app/outputs/flutter-apk/

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: guarch-debug-apk
          path: app/build/app/outputs/flutter-apk/app-debug.apk

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            /tmp/build.log
            /tmp/gomobile.log
