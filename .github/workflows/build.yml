name: Build Guarch

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Download dependencies
        run: |
          go mod tidy
          go mod download

      - name: Run tests
        run: go test ./... -v

      - name: Build server (Linux AMD64)
        run: |
          GOOS=linux GOARCH=amd64 go build -o bin/guarch-server-linux-amd64 ./cmd/guarch-server/
          GOOS=linux GOARCH=arm64 go build -o bin/guarch-server-linux-arm64 ./cmd/guarch-server/

      - name: Build client (Linux AMD64)
        run: |
          GOOS=linux GOARCH=amd64 go build -o bin/guarch-client-linux-amd64 ./cmd/guarch-client/

      - name: Build client (Windows)
        run: |
          GOOS=windows GOARCH=amd64 go build -o bin/guarch-client-windows.exe ./cmd/guarch-client/

      - name: Upload server binaries
        uses: actions/upload-artifact@v4
        with:
          name: guarch-server
          path: bin/guarch-server-*

      - name: Upload client binaries
        uses: actions/upload-artifact@v4
        with:
          name: guarch-client
          path: bin/guarch-client-*

  build-android:
    runs-on: ubuntu-latest
    needs: build-server
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;25.2.9519653"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Download Go dependencies
        run: |
          go mod tidy
          go mod download

      - name: Install gomobile
        run: |
          go get golang.org/x/mobile/bind
          go get golang.org/x/mobile/cmd/gomobile
          go get golang.org/x/mobile/cmd/gobind
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          export PATH=$PATH:$(go env GOPATH)/bin
          echo "PATH=$PATH:$(go env GOPATH)/bin" >> $GITHUB_ENV
          gomobile init

      - name: Build Go mobile library
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          mkdir -p app/android/app/libs
          gomobile bind -target=android -androidapi 21 \
            -o app/android/app/libs/mobile.aar \
            ./mobile/

      - name: DEBUG - Find the problem
        working-directory: app
        run: |
          echo "========================================="
          echo "1. Flutter version"
          echo "========================================="
          flutter --version

          echo ""
          echo "========================================="
          echo "2. List all android files"
          echo "========================================="
          find android/ -type f -name "*.xml" -o -name "*.gradle" -o -name "*.kt" -o -name "*.java" -o -name "*.properties" | sort

          echo ""
          echo "========================================="
          echo "3. Check AndroidManifest for v1 embedding"
          echo "========================================="
          find android/ -name "AndroidManifest.xml" -exec echo "--- {} ---" \; -exec cat {} \;

          echo ""
          echo "========================================="
          echo "4. Check for FlutterApplication (v1 sign)"
          echo "========================================="
          grep -r "FlutterApplication" android/ || echo "NOT FOUND - Good!"

          echo ""
          echo "========================================="
          echo "5. Check for old GeneratedPluginRegistrant"
          echo "========================================="
          grep -r "GeneratedPluginRegistrant" android/ || echo "NOT FOUND"

          echo ""
          echo "========================================="
          echo "6. Check MainActivity"
          echo "========================================="
          find android/ -name "MainActivity.*" -exec echo "--- {} ---" \; -exec cat {} \;

          echo ""
          echo "========================================="
          echo "7. Check build.gradle files"
          echo "========================================="
          find android/ -name "build.gradle*" -exec echo "--- {} ---" \; -exec cat {} \;

          echo ""
          echo "========================================="
          echo "8. Check settings.gradle"
          echo "========================================="
          find android/ -name "settings.gradle*" -exec echo "--- {} ---" \; -exec cat {} \;

          echo ""
          echo "========================================="
          echo "9. Check gradle.properties"
          echo "========================================="
          find android/ -name "gradle.properties" -exec echo "--- {} ---" \; -exec cat {} \;

          echo ""
          echo "========================================="
          echo "10. Check gradle-wrapper.properties"
          echo "========================================="
          find android/ -name "gradle-wrapper.properties" -exec echo "--- {} ---" \; -exec cat {} \;

          echo ""
          echo "========================================="
          echo "11. pubspec.lock versions"
          echo "========================================="
          rm -f pubspec.lock
          flutter pub get
          cat pubspec.lock | grep -A 3 "share_plus\|connectivity_plus\|flutter_local_notifications\|permission_handler"

          echo ""
          echo "========================================="
          echo "12. Flutter doctor"
          echo "========================================="
          flutter doctor -v

      - name: Try Build APK with verbose
        working-directory: app
        run: flutter build apk --release -v 2>&1 | tail -100

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: guarch-android
          path: app/build/app/outputs/flutter-apk/app-release.apk
