name: Update Go deps for gVisor

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: debug
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Update dependencies
        run: |
          # gVisor netstack (جایگزین tun2socks)
          go get gvisor.dev/gvisor/pkg/tcpip@latest
          go get gvisor.dev/gvisor/pkg/tcpip/adapters/gonet@latest
          go get gvisor.dev/gvisor/pkg/tcpip/link/fdbased@latest
          go get gvisor.dev/gvisor/pkg/tcpip/header@latest
          
          # SOCKS5 proxy dialer
          go get golang.org/x/net/proxy@latest
          
          # gomobile bind
          go get golang.org/x/mobile/bind@latest
          
          go mod tidy
          
          echo "=== go.mod ==="
          cat go.mod

      - name: Verify build
        run: |
          go build ./mobile/ 2>&1 || true
          echo "Done"

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add go.mod go.sum
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "deps: add gVisor netstack + x/net/proxy"
          git push
